"use strict";(()=>{var e={};e.id=622,e.ids=[622],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},5212:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>O,patchFetch:()=>R,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>N,staticGenerationAsyncStorage:()=>E});var n={};t.r(n),t.d(n,{DELETE:()=>g,GET:()=>_,POST:()=>m,PUT:()=>y});var a=t(9303),i=t(8716),r=t(670),c=t(1615),o=t(8632),u=t(6385),l=t(3534),p=t(7070);async function d(){let e=await (0,c.cookies)(),s=await (0,o.iW)(e,l.d);return s.userId?s:null}async function _(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let{searchParams:s}=new URL(e.url),t=s.get("id");if(t){let e=await (0,u.E4)(`SELECT l.*, s.name as shop_name, lt.name as type_name,
                        u.full_name as created_by_name
                 FROM licenses l 
                 JOIN shops s ON l.shop_id = s.id
                 JOIN license_types lt ON l.license_type_id = lt.id
                 LEFT JOIN users u ON l.created_by = u.id 
                 WHERE l.id = $1`,[t]);return p.NextResponse.json({success:!0,message:"Success",license:e})}{let e=s.get("search")||"",t=s.get("status")||"",n=s.get("license_type")||"",a=s.get("shop_id")||"",i=Math.max(1,parseInt(s.get("page")||"1")),r=Math.min(100,Math.max(10,parseInt(s.get("limit")||"20"))),c=(i-1)*r,o=[],l=[],d=1;e&&(o.push(`s.name ILIKE $${d++}`),l.push(`%${e}%`)),t&&(o.push(`l.status = $${d++}`),l.push(t)),n&&(o.push(`l.license_type_id = $${d++}`),l.push(n)),a&&(o.push(`l.shop_id = $${d++}`),l.push(a));let _=o.length>0?"WHERE "+o.join(" AND "):"",m=await (0,u.E4)(`SELECT COUNT(*) as total
                 FROM licenses l 
                 JOIN shops s ON l.shop_id = s.id
                 JOIN license_types lt ON l.license_type_id = lt.id
                 ${_}`,l),y=parseInt(m?.total||0),g=Math.ceil(y/r),h=await (0,u.Qd)(`SELECT l.*, s.name as shop_name, lt.name as type_name,
                        u.full_name as created_by_name,
                        (l.expiry_date - CURRENT_DATE) as days_until_expiry
                 FROM licenses l 
                 JOIN shops s ON l.shop_id = s.id
                 JOIN license_types lt ON l.license_type_id = lt.id
                 LEFT JOIN users u ON l.created_by = u.id 
                 ${_}
                 ORDER BY l.expiry_date ASC
                 LIMIT $${d++} OFFSET $${d}`,[...l,r,c]);return p.NextResponse.json({success:!0,message:"Success",licenses:h,pagination:{page:i,limit:r,total:y,totalPages:g}})}}catch(e){return console.error("Licenses GET error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function m(e){try{let s=await d();if(!s)return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let t=await e.json();if(!t.shop_id||!t.license_type_id||!t.issue_date||!t.expiry_date)return p.NextResponse.json({success:!1,message:"กรุณากรอกข้อมูลให้ครบถ้วน"});let n=await (0,u.$T)("licenses",{shop_id:t.shop_id,license_type_id:t.license_type_id,license_number:t.license_number||null,issue_date:t.issue_date,expiry_date:t.expiry_date,status:t.status||"active",notes:t.notes||null,created_by:s.userId});return p.NextResponse.json({success:!0,message:"เพิ่มใบอนุญาตสำเร็จ",id:n})}catch(e){return console.error("Licenses POST error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function y(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let s=await e.json();if(!s.id)return p.NextResponse.json({success:!1,message:"Missing license ID"});return await (0,u.Vx)("licenses",{shop_id:s.shop_id,license_type_id:s.license_type_id,license_number:s.license_number||null,issue_date:s.issue_date,expiry_date:s.expiry_date,status:s.status,notes:s.notes||null},"id = ?",[s.id]),p.NextResponse.json({success:!0,message:"แก้ไขข้อมูลใบอนุญาตสำเร็จ"})}catch(e){return console.error("Licenses PUT error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function g(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let{searchParams:s}=new URL(e.url),t=s.get("id");if(!t)return p.NextResponse.json({success:!1,message:"Missing license ID"});return await (0,u.Od)("licenses","id = ?",[t]),p.NextResponse.json({success:!0,message:"ลบใบอนุญาตสำเร็จ"})}catch(e){return console.error("Licenses DELETE error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/licenses/route",pathname:"/api/licenses",filename:"route",bundlePath:"app/api/licenses/route"},resolvedPagePath:"C:\\Users\\RareMz\\Test\\src\\app\\api\\licenses\\route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:E,serverHooks:N}=h,O="/api/licenses/route";function R(){return(0,r.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:E})}},6385:(e,s,t)=>{t.d(s,{$T:()=>c,E4:()=>i,Od:()=>u,Qd:()=>r,Vx:()=>o});let n=(0,t(2237).qn)(process.env.DATABASE_URL);async function a(e,s=[]){return await n(e,s)}async function i(e,s=[]){return(await a(e,s))[0]||null}async function r(e,s=[]){return await a(e,s)}async function c(e,s){let t=Object.keys(s).join(", "),a=Object.keys(s).map((e,s)=>`$${s+1}`).join(", "),i=Object.values(s),r=`INSERT INTO ${e} (${t}) VALUES (${a}) RETURNING id`,c=await n(r,i);return c[0]?.id}async function o(e,s,t,a=[]){let i=Object.keys(s).map((e,s)=>`${e} = $${s+1}`).join(", "),r=[...Object.values(s),...a],c=Object.keys(s).length+1,o=t.replace(/\?/g,()=>`$${c++}`),u=`UPDATE ${e} SET ${i} WHERE ${o}`;return(await n(u,r)).length}async function u(e,s,t=[]){let a=1,i=s.replace(/\?/g,()=>`$${a++}`),r=`DELETE FROM ${e} WHERE ${i}`;return(await n(r,t)).length}},3534:(e,s,t)=>{t.d(s,{d:()=>n});let n={password:process.env.SESSION_SECRET||"complex_password_at_least_32_characters_long",cookieName:"shop_license_session",cookieOptions:{secure:!0,httpOnly:!0,sameSite:"lax",maxAge:1800}}}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),n=s.X(0,[276,397],()=>t(5212));module.exports=n})();