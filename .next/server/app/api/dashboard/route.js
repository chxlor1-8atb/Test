"use strict";(()=>{var e={};e.id=707,e.ids=[707],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},1054:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>O,patchFetch:()=>y,requestAsyncStorage:()=>x,routeModule:()=>T,serverHooks:()=>N,staticGenerationAsyncStorage:()=>_});var a={};s.r(a),s.d(a,{GET:()=>l});var n=s(9303),r=s(8716),i=s(670),o=s(1615),c=s(8632),u=s(6385),p=s(3534),E=s(7070);async function l(e){try{let t=await (0,o.cookies)();if(!(await (0,c.iW)(t,p.d)).userId)return E.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let{searchParams:s}=new URL(e.url);switch(s.get("action")||"stats"){case"stats":default:return await d();case"license_breakdown":return await R()}}catch(e){return console.error("Dashboard error:",e),E.NextResponse.json({success:!1,message:"เกิดข้อผิดพลาด: "+e.message},{status:500})}}async function d(){let e=await (0,u.E4)("SELECT COUNT(*) as count FROM shops"),t=parseInt(e?.count||0),s=await (0,u.E4)("SELECT COUNT(*) as count FROM licenses"),a=parseInt(s?.count||0),n=await (0,u.E4)("SELECT COUNT(*) as count FROM licenses WHERE status = 'active' AND expiry_date >= CURRENT_DATE"),r=parseInt(n?.count||0),i=await (0,u.E4)("SELECT COUNT(*) as count FROM licenses WHERE status = 'expired' OR expiry_date < CURRENT_DATE"),o=parseInt(i?.count||0),c=await (0,u.E4)("SELECT COUNT(*) as count FROM licenses WHERE status = 'active' AND expiry_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'"),p=parseInt(c?.count||0),l=await (0,u.E4)("SELECT COUNT(*) as count FROM users"),d=parseInt(l?.count||0);return E.NextResponse.json({success:!0,message:"Success",stats:{total_shops:t,total_licenses:a,active_licenses:r,expired_licenses:o,expiring_soon:p,total_users:d,expiry_warning_days:30},expiring:[]})}async function R(){let e=await (0,u.Qd)(`SELECT 
            lt.id,
            lt.name as type_name,
            COUNT(l.id) as total_count,
            SUM(CASE WHEN l.status = 'active' AND l.expiry_date >= CURRENT_DATE THEN 1 ELSE 0 END) as active_count,
            SUM(CASE WHEN l.status = 'expired' OR l.expiry_date < CURRENT_DATE THEN 1 ELSE 0 END) as expired_count
         FROM license_types lt
         LEFT JOIN licenses l ON lt.id = l.license_type_id
         GROUP BY lt.id, lt.name
         ORDER BY total_count DESC`);return E.NextResponse.json({success:!0,message:"Success",breakdown:e})}let T=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/dashboard/route",pathname:"/api/dashboard",filename:"route",bundlePath:"app/api/dashboard/route"},resolvedPagePath:"C:\\Users\\RareMz\\Test\\src\\app\\api\\dashboard\\route.js",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:_,serverHooks:N}=T,O="/api/dashboard/route";function y(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:_})}},6385:(e,t,s)=>{s.d(t,{$T:()=>o,E4:()=>r,Od:()=>u,Qd:()=>i,Vx:()=>c});let a=(0,s(2237).qn)(process.env.DATABASE_URL);async function n(e,t=[]){return await a(e,t)}async function r(e,t=[]){return(await n(e,t))[0]||null}async function i(e,t=[]){return await n(e,t)}async function o(e,t){let s=Object.keys(t).join(", "),n=Object.keys(t).map((e,t)=>`$${t+1}`).join(", "),r=Object.values(t),i=`INSERT INTO ${e} (${s}) VALUES (${n}) RETURNING id`,o=await a(i,r);return o[0]?.id}async function c(e,t,s,n=[]){let r=Object.keys(t).map((e,t)=>`${e} = $${t+1}`).join(", "),i=[...Object.values(t),...n],o=Object.keys(t).length+1,c=s.replace(/\?/g,()=>`$${o++}`),u=`UPDATE ${e} SET ${r} WHERE ${c}`;return(await a(u,i)).length}async function u(e,t,s=[]){let n=1,r=t.replace(/\?/g,()=>`$${n++}`),i=`DELETE FROM ${e} WHERE ${r}`;return(await a(i,s)).length}},3534:(e,t,s)=>{s.d(t,{d:()=>a});let a={password:process.env.SESSION_SECRET||"complex_password_at_least_32_characters_long",cookieName:"shop_license_session",cookieOptions:{secure:!0,httpOnly:!0,sameSite:"lax",maxAge:1800}}}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[276,397],()=>s(1054));module.exports=a})();