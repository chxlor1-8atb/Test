"use strict";(()=>{var e={};e.id=888,e.ids=[888],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},4466:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>R,routeModule:()=>x,serverHooks:()=>N,staticGenerationAsyncStorage:()=>j});var n={};t.r(n),t.d(n,{DELETE:()=>E,GET:()=>m,POST:()=>h,PUT:()=>g});var a=t(9303),r=t(8716),o=t(670),c=t(1615),i=t(8632),u=t(6385),l=t(3534),p=t(7070);async function d(){let e=await (0,c.cookies)(),s=await (0,i.iW)(e,l.d);return s.userId?s:null}async function m(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let{searchParams:s}=new URL(e.url),t=s.get("id");if(t){let e=await (0,u.E4)(`SELECT s.*, u.full_name as created_by_name 
                 FROM shops s 
                 LEFT JOIN users u ON s.created_by = u.id 
                 WHERE s.id = $1`,[t]);return p.NextResponse.json({success:!0,message:"Success",shop:e})}{let e=s.get("search")||"",t=Math.max(1,parseInt(s.get("page")||"1")),n=Math.min(100,Math.max(10,parseInt(s.get("limit")||"20"))),a=(t-1)*n,r="",o=[];e&&(r="WHERE s.name ILIKE $1 OR s.owner_name ILIKE $1",o=[`%${e}%`]);let c=await (0,u.E4)(`SELECT COUNT(*) as total FROM shops s ${r}`,o),i=parseInt(c?.total||0),l=Math.ceil(i/n),d=await (0,u.Qd)(`SELECT s.*, u.full_name as created_by_name,
                        (SELECT COUNT(*) FROM licenses l WHERE l.shop_id = s.id) as license_count
                 FROM shops s 
                 LEFT JOIN users u ON s.created_by = u.id 
                 ${r}
                 ORDER BY s.id DESC
                 LIMIT $${o.length+1} OFFSET $${o.length+2}`,[...o,n,a]);return p.NextResponse.json({success:!0,message:"Success",shops:d,pagination:{page:t,limit:n,total:i,totalPages:l}})}}catch(e){return console.error("Shops GET error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function h(e){try{let s=await d();if(!s)return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let t=await e.json();if(!t.name)return p.NextResponse.json({success:!1,message:"กรุณากรอกชื่อร้านค้า"});let n=await (0,u.$T)("shops",{name:t.name,owner_name:t.owner_name||null,address:t.address||null,phone:t.phone||null,email:t.email||null,notes:t.notes||null,created_by:s.userId});return p.NextResponse.json({success:!0,message:"เพิ่มร้านค้าสำเร็จ",id:n})}catch(e){return console.error("Shops POST error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function g(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let s=await e.json();if(!s.id)return p.NextResponse.json({success:!1,message:"Missing shop ID"});return await (0,u.Vx)("shops",{name:s.name,owner_name:s.owner_name||null,address:s.address||null,phone:s.phone||null,email:s.email||null,notes:s.notes||null},"id = ?",[s.id]),p.NextResponse.json({success:!0,message:"แก้ไขข้อมูลร้านค้าสำเร็จ"})}catch(e){return console.error("Shops PUT error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}async function E(e){try{if(!await d())return p.NextResponse.json({success:!1,message:"Not authenticated"},{status:401});let{searchParams:s}=new URL(e.url),t=s.get("id");if(!t)return p.NextResponse.json({success:!1,message:"Missing shop ID"});return await (0,u.Od)("shops","id = ?",[t]),p.NextResponse.json({success:!0,message:"ลบร้านค้าสำเร็จ"})}catch(e){return console.error("Shops DELETE error:",e),p.NextResponse.json({success:!1,message:e.message},{status:500})}}let x=new a.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/shops/route",pathname:"/api/shops",filename:"route",bundlePath:"app/api/shops/route"},resolvedPagePath:"C:\\Users\\RareMz\\Test\\src\\app\\api\\shops\\route.js",nextConfigOutput:"",userland:n}),{requestAsyncStorage:R,staticGenerationAsyncStorage:j,serverHooks:N}=x,w="/api/shops/route";function y(){return(0,o.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:j})}},6385:(e,s,t)=>{t.d(s,{$T:()=>c,E4:()=>r,Od:()=>u,Qd:()=>o,Vx:()=>i});let n=(0,t(2237).qn)(process.env.DATABASE_URL);async function a(e,s=[]){return await n(e,s)}async function r(e,s=[]){return(await a(e,s))[0]||null}async function o(e,s=[]){return await a(e,s)}async function c(e,s){let t=Object.keys(s).join(", "),a=Object.keys(s).map((e,s)=>`$${s+1}`).join(", "),r=Object.values(s),o=`INSERT INTO ${e} (${t}) VALUES (${a}) RETURNING id`,c=await n(o,r);return c[0]?.id}async function i(e,s,t,a=[]){let r=Object.keys(s).map((e,s)=>`${e} = $${s+1}`).join(", "),o=[...Object.values(s),...a],c=Object.keys(s).length+1,i=t.replace(/\?/g,()=>`$${c++}`),u=`UPDATE ${e} SET ${r} WHERE ${i}`;return(await n(u,o)).length}async function u(e,s,t=[]){let a=1,r=s.replace(/\?/g,()=>`$${a++}`),o=`DELETE FROM ${e} WHERE ${r}`;return(await n(o,t)).length}},3534:(e,s,t)=>{t.d(s,{d:()=>n});let n={password:process.env.SESSION_SECRET||"complex_password_at_least_32_characters_long",cookieName:"shop_license_session",cookieOptions:{secure:!0,httpOnly:!0,sameSite:"lax",maxAge:1800}}}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),n=s.X(0,[276,397],()=>t(4466));module.exports=n})();